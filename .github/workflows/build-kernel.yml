name: Build Glow-Delta Kernel for Marble Device

# å½“ä»£ç æ¨é€åˆ° main/master åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œè¿è¡Œæ­¤å·¥ä½œæµ
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    # åœ¨æœ€æ–°çš„ Ubuntu è™šæ‹Ÿæœºä¸Šæ‰§è¡Œæ„å»ºä»»åŠ¡
    runs-on: ubuntu-latest
    # è®¾ç½®æ„å»ºç¯å¢ƒçš„è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢é•¿æ—¶é—´å¡æ­»
    timeout-minutes: 90

    steps:
    - name: ğŸš€ Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        # é€’å½’å…‹éš†æ‰€æœ‰å­æ¨¡å—ï¼ŒGlow-Delta é€šå¸¸ä¼šç”¨åˆ°
        submodules: true
        # å°†å†…æ ¸æºç å…‹éš†åˆ° 'kernel_source' ç›®å½•ï¼Œä¸ AnyKernel3 ç›®å½•åˆ†ç¦»
        path: kernel_source

    - name: ğŸ“¦ Install Build Dependencies
      run: |
        echo "Updating apt package list..."
        sudo apt update
        echo "Installing essential build tools and libraries..."
        # åŒ…å«äº†ç¼–è¯‘ Android å†…æ ¸æ‰€éœ€çš„å¸¸ç”¨è½¯ä»¶åŒ…
        # realpath å·²ç»ç§»é™¤ï¼Œå› ä¸ºå®ƒåœ¨æœ€æ–°ç¯å¢ƒä¸­å¯èƒ½ä¸å†éœ€è¦æˆ–å­˜åœ¨å…¼å®¹æ€§é—®é¢˜
        sudo apt install -y \
          git flex bison build-essential libncurses-dev libssl-dev bc \
          ccache rsync zlib1g-dev python3-minimal libelf-dev libxml2-utils \
          gnupg wget unzip

    - name: âš™ï¸ Download & Setup Android NDK (Clang Toolchain)
      run: |
        # --- !!! è¯·æ ¹æ®å†…æ ¸è¦æ±‚è°ƒæ•´ NDK ç‰ˆæœ¬ !!! ---
        # æ¨èä½¿ç”¨ r25c, r26c, r27b ç­‰ç¨³å®šç‰ˆæœ¬ã€‚å¦‚æœç¼–è¯‘å¤±è´¥ï¼Œå°è¯•æ›´æ¢ NDK ç‰ˆæœ¬ã€‚
        NDK_VERSION="r26c" 
        NDK_FILE="android-ndk-${NDK_VERSION}-linux.zip"
        NDK_URL="https://dl.google.com/android/repository/${NDK_FILE}"

        echo "Attempting to download NDK from: ${NDK_URL}"
        wget "${NDK_URL}" -O /tmp/${NDK_FILE} || { echo "Failed to download NDK!"; exit 1; }
        echo "Extracting NDK..."
        unzip -q /tmp/${NDK_FILE} -d ~/android-ndk-temp/ || { echo "Failed to extract NDK!"; exit 1; }
        
        # åŠ¨æ€æŸ¥æ‰¾ Clang å·¥å…·é“¾çš„ç²¾ç¡®è·¯å¾„
        # é€šå¸¸ä½äº toolchains/llvm/prebuilt/linux-x86_64/bin
        # ä½¿ç”¨ 'head -n 1' ç¡®ä¿åªå–ç¬¬ä¸€ä¸ªç»“æœ
        TOOLCHAIN_ROOT_DIR=$(find ~/android-ndk-temp/android-ndk-${NDK_VERSION}/toolchains/llvm -name 'linux-x86_64' -type d | head -n 1)
        export TOOLCHAIN_DIR="${TOOLCHAIN_ROOT_DIR}/bin"
        
        if [ -z "$TOOLCHAIN_ROOT_DIR" ] || [ ! -d "$TOOLCHAIN_DIR" ]; then
          echo "Error: NDK toolchain directory not found for version ${NDK_VERSION}." 1>&2
          echo "Please verify the NDK_VERSION and NDK archive structure." 1>&2
          exit 1
        fi

        echo "NDK Toolchain found at: ${TOOLCHAIN_DIR}"
        # å°†å·¥å…·é“¾è·¯å¾„æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡ï¼Œè¿™æ · make å‘½ä»¤æ‰èƒ½æ‰¾åˆ° clang/ld ç­‰å·¥å…·
        echo "PATH=${TOOLCHAIN_DIR}:${PATH}" >> $GITHUB_ENV
        # è®¾ç½® KERNEL_TOOLCHAIN ç¯å¢ƒå˜é‡ï¼Œéƒ¨åˆ†å†…æ ¸ Makefile å¯èƒ½éœ€è¦
        echo "KERNEL_TOOLCHAIN=${TOOLCHAIN_DIR}" >> $GITHUB_ENV
        
        # æ¸…ç†ä¸´æ—¶ NDK æ–‡ä»¶ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´
        echo "Cleaning up temporary NDK archive..."
        rm /tmp/${NDK_FILE}

    - name: ğŸ› ï¸ Set Kernel Build Environment Variables & Setup CCACHE
      run: |
        echo "Setting up ARCH, SUBARCH, and CROSS_COMPILE..."
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-android-" >> $GITHUB_ENV
        echo "CROSS_COMPILE_ARM64=aarch64-linux-android-" >> $GITHUB_ENV # éƒ¨åˆ†å†…æ ¸éœ€è¦

        echo "Setting KBUILD build user and host info..."
        echo "KBUILD_BUILD_USER=GitHubActions" >> $GITHUB_ENV
        echo "KBUILD_BUILD_HOST=GitHub" >> $GITHUB_ENV
        
        echo "Configuring ccache..."
        # è®¾ç½® ccache ç›®å½•
        echo "CCACHE_DIR=/github/workspace/.ccache" >> $GITHUB_ENV
        # æ‰¾åˆ° ccache å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„
        echo "CCACHE_EXEC=$(which ccache)" >> $GITHUB_ENV
        # å¯ç”¨ ccache
        echo "USE_CCACHE=1" >> $GITHUB_ENV
        
        # ç¡®ä¿ ccache ç›®å½•å­˜åœ¨å¹¶å…·æœ‰å†™å…¥æƒé™ï¼Œè§£å†³ "Permission denied" é”™è¯¯
        mkdir -p "${{ github.workspace }}/.ccache" || { echo "Failed to create ccache directory!"; exit 1; }
        chmod 777 "${{ github.workspace }}/.ccache" || { echo "Failed to set permissions for ccache directory!"; exit 1; }
        echo "CCACHE directory created and permissions set: ${{ github.workspace }}/.ccache"

    - name: âš™ï¸ Configure Kernel (defconfig)
      run: |
        echo "Configuring kernel with marble_defconfig..."
        # ä½¿ç”¨ 'marble_defconfig' ä½œä¸ºä½ çš„è®¾å¤‡é…ç½®æ–‡ä»¶
        # ç¡®ä¿æ­¤æ–‡ä»¶å­˜åœ¨äº kernel_source/arch/arm64/configs/
        make O=out marble_defconfig || { echo "Failed to configure kernel with marble_defconfig!"; exit 1; }
        # å¯¹äº Android å†…æ ¸ï¼Œé€šå¸¸æ¨èä½¿ç”¨ 'O=out' å°†æ„å»ºè¾“å‡ºé‡å®šå‘åˆ°å•ç‹¬çš„ç›®å½•
        # è¿™æ ·å¯ä»¥ä¿æŒæºä»£ç æ ‘çš„æ¸…æ´
      working-directory: ./kernel_source

    - name: ğŸ”¨ Build Kernel Image
      run: |
        echo "Starting kernel compilation..."
        # ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„ CPU æ ¸å¿ƒè¿›è¡Œå¹¶è¡Œç¼–è¯‘
        # ä½¿ç”¨ 'make O=out' ç¡®ä¿åœ¨æŒ‡å®šè¾“å‡ºç›®å½•ä¸­è¿›è¡Œç¼–è¯‘
        make O=out -j$(nproc --all) || { echo "Kernel compilation failed!"; exit 1; }
      working-directory: ./kernel_source

    - name: ğŸ“¥ Checkout AnyKernel3
      uses: actions/checkout@v4
      with:
        # --- !!! å…³é”®é…ç½®ï¼šè¯·æ›¿æ¢ä¸ºä½ çš„ AnyKernel3 ä»“åº“åœ°å€ !!! ---
        # å¼ºçƒˆå»ºè®®ä½  Fork osm0sis/AnyKernel3 åˆ°ä½ è‡ªå·±çš„ GitHub è´¦å·ä¸‹ï¼Œ
        # ç„¶åå°† 'osm0sis/AnyKernel3' æ›¿æ¢ä¸º 'ä½ çš„ç”¨æˆ·å/AnyKernel3'ã€‚
        # ä¾‹å¦‚: 'Guxin12/AnyKernel3'
        repository: osm0sis/AnyKernel3 
        # AnyKernel3 çš„åˆ†æ”¯ï¼Œé€šå¸¸æ˜¯ 'master' æˆ– 'main'
        ref: master 
        # å°† AnyKernel3 å…‹éš†åˆ° 'AnyKernel3' ç›®å½•
        path: AnyKernel3 

    - name: ğŸ“¦ Prepare AnyKernel3 for Packaging
      run: |
        echo "Preparing AnyKernel3 for packaging..."
        # å¤åˆ¶ç¼–è¯‘å¥½çš„å†…æ ¸é•œåƒåˆ° AnyKernel3 ç›®å½•
        # æ ¹æ®ä½ çš„ä¿¡æ¯ï¼Œæœ€ç»ˆäº§ç‰©æ˜¯ Image.gz-dtb
        # ç¡®ä¿è·¯å¾„ 'kernel_source/out/arch/arm64/boot/Image.gz-dtb' æ˜¯æ­£ç¡®çš„
        # å› ä¸ºæˆ‘ä»¬åœ¨ 'Configure Kernel' å’Œ 'Build Kernel' ä¸­ä½¿ç”¨äº† 'O=out'
        cp kernel_source/out/arch/arm64/boot/Image.gz-dtb AnyKernel3/ || { echo "Failed to copy Image.gz-dtb!"; exit 1; }
        
        # --- !!! å¯é€‰ï¼Œä½†å¯èƒ½éœ€è¦æ ¹æ®ä½ çš„è®¾å¤‡å’Œå†…æ ¸é…ç½®è°ƒæ•´ !!! ---
        # å¦‚æœä½ çš„è®¾å¤‡éœ€è¦å•ç‹¬çš„ dtb.img å¹¶ä¸”å†…æ ¸ä¼šç”Ÿæˆå®ƒï¼Œåœ¨è¿™é‡Œå¤åˆ¶ã€‚
        # å¦‚æœ Image.gz-dtb å·²ç»åŒ…å«äº† DTBï¼Œåˆ™æ­¤è¡Œæ— éœ€ã€‚
        # ä¾‹å¦‚ï¼šcp kernel_source/out/arch/arm64/boot/dtb.img AnyKernel3/ || { echo "Failed to copy dtb.img!"; exit 1; }
        # å¦ä¸€ä¸ªå¸¸è§æƒ…å†µï¼šå¦‚æœå†…æ ¸ç¼–è¯‘ç”Ÿæˆçš„æ˜¯ Image è€Œä¸æ˜¯ Image.gz-dtbï¼Œä½ éœ€è¦æ‰‹åŠ¨æå–DTB
        # ä¾‹å¦‚ï¼š
        # cd AnyKernel3 
        # ./anykernel.sh --extract-dtb ../kernel_source/out/arch/arm64/boot/Image || { echo "Failed to extract dtb!"; exit 1; }
        # cd ..

        # æ¸…ç† AnyKernel3 ä¸­å¯èƒ½ä¸éœ€è¦çš„å ä½ç¬¦æ–‡ä»¶ï¼Œç¡®ä¿æˆ‘ä»¬è‡ªå·±çš„æ–‡ä»¶ç”Ÿæ•ˆ
        rm -f AnyKernel3/Image.gz-dtb-placeholder AnyKernel3/zImage AnyKernel3/boot.img
        
        # è·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¹¶æ›´æ–° AnyKernel3 çš„ zip æ–‡ä»¶åå’Œå†…æ ¸è¯†åˆ«å­—ç¬¦ä¸²
        # è¿™äº›ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨åˆ·æœºæ—¶ï¼ˆTWRPï¼‰æˆ–ç”Ÿæˆçš„åˆ·æœºåŒ…åç§°ä¸­
        KERNEL_VERSION=$(cd kernel_source && make kernelversion)
        BUILD_DATE=$(date +%Y%m%d)
        BUILD_TIME=$(date +%H%M)
        
        echo "Setting kernel.string and zipname in AnyKernel3/anykernel.sh..."
        # å°†å†…æ ¸è¯†åˆ«å­—ç¬¦ä¸²å†™å…¥ anykernel.sh
        echo "kernel.string=GlowDelta-Kernel-${KERNEL_VERSION}-${BUILD_DATE}-${BUILD_TIME}-${{ github.sha_short }}" >> AnyKernel3/anykernel.sh
        # è®¾ç½®æœ€ç»ˆçš„å¡åˆ·åŒ…æ–‡ä»¶å
        echo "zipname=GlowDelta-Kernel-${KERNEL_VERSION}-${BUILD_DATE}-${{ github.run_number }}.zip" >> AnyKernel3/anykernel.sh
        
        # éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å·²å¤åˆ¶åˆ° AnyKernel3 ç›®å½•
        echo "Contents of AnyKernel3/ folder after kernel copy and cleanup:"
        ls -l AnyKernel3/

    - name: âš™ï¸ Package Kernel with AnyKernel3
      run: |
        echo "Running AnyKernel3 packaging script..."
        # æ‰§è¡Œ AnyKernel3 çš„æ‰“åŒ…è„šæœ¬ï¼Œç”Ÿæˆæœ€ç»ˆçš„ .zip æ–‡ä»¶
        # AnyKernel3 çš„ '--build-zip' å‘½ä»¤ä¼šè‡ªåŠ¨å¤„ç†æ‰“åŒ…å’Œå‘½å
        bash anykernel.sh --build-zip || { echo "AnyKernel3 packaging failed!"; exit 1; }
      working-directory: ./AnyKernel3 # ç¡®ä¿åœ¨ 'AnyKernel3' ç›®å½•ä¸­æ‰§è¡Œæ‰“åŒ…å‘½ä»¤
      
    - name: ğŸ” Find and Rename Output Zip
      id: get_zip_name # ç»™è¿™ä¸ªæ­¥éª¤ä¸€ä¸ªIDï¼Œæ–¹ä¾¿åç»­å¼•ç”¨è¾“å‡º
      run: |
        echo "Locating and renaming the generated zip file..."
        # ä» AnyKernel3 çš„ anykernel.sh ä¸­è·å–æœŸæœ›çš„ zip æ–‡ä»¶å
        GENERATED_ZIP_NAME=$(sed -n 's/^zipname=//p' AnyKernel3/anykernel.sh | tr -d '\r') # tr -d '\r' å¤„ç†å¯èƒ½å­˜åœ¨çš„CRLFæ¢è¡Œç¬¦

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº AnyKernel3 ç›®å½•å†…
        if [ -f "AnyKernel3/${GENERATED_ZIP_NAME}" ]; then
            OLD_ZIP_PATH="AnyKernel3/${GENERATED_ZIP_NAME}"
            echo "Found generated zip in AnyKernel3 folder: ${OLD_ZIP_PATH}"
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºå·¥ä½œåŒºæ ¹ç›®å½•ï¼ˆAnyKernel3çš„çˆ¶ç›®å½•ï¼‰
        elif [ -f "${GENERATED_ZIP_NAME}" ]; then
            OLD_ZIP_PATH="${GENERATED_ZIP_NAME}"
            echo "Found generated zip in root: ${OLD_ZIP_PATH}"
        else
            # å¤‡ç”¨æŸ¥æ‰¾æ–¹å¼ï¼šå¦‚æœ AnyKernel3 çš„è¾“å‡ºä½ç½®æˆ–å‘½åè§„åˆ™æœ‰å˜ï¼Œå°è¯•æ³›æŸ¥æ‰¾
            echo "Attempting wildcard search for zip file..."
            LATEST_ZIP=$(find . -name "GlowDelta-Kernel-*.zip" -type f -print | sort -r | head -n 1)
            if [ -f "${LATEST_ZIP}" ]; then
                OLD_ZIP_PATH="${LATEST_ZIP}"
                echo "Found latest zip using wildcard: ${OLD_ZIP_PATH}"
            else
                echo "Error: Could not find the generated zip file after packaging! Please check AnyKernel3 output." 1>&2
                exit 1
            fi
        fi

        # å°†æ—§çš„ zip æ–‡ä»¶è·¯å¾„è¾“å‡ºç»™ä¸‹ä¸€æ­¥
        echo "OLD_ZIP_NAME=${OLD_ZIP_PATH}" >> $GITHUB_OUTPUT

        # å®šä¹‰æ–°çš„ã€æ›´æ¸…æ™°çš„ä¸Šä¼ æ–‡ä»¶åï¼Œæ–¹ä¾¿ä¸‹è½½
        NEW_ZIP_NAME="GlowDelta-Kernel-Flashable.zip"
        echo "NEW_ZIP_NAME=${NEW_ZIP_NAME}" >> $GITHUB_OUTPUT

        # é‡å‘½åæ–‡ä»¶ï¼Œä»¥ä¾¿ Upload Artifacts æ­¥éª¤èƒ½å¤Ÿæ‰¾åˆ°å¹¶ä¸Šä¼ 
        mv "${OLD_ZIP_PATH}" "${NEW_ZIP_NAME}" || { echo "Failed to rename zip file!"; exit 1; }
        echo "Renamed zip file to: ${NEW_ZIP_NAME}"
        ls -l # å†æ¬¡åˆ—å‡ºæ–‡ä»¶ï¼Œç¡®è®¤é‡å‘½åæˆåŠŸ
        
      working-directory: ./ # åœ¨å·¥ä½œåŒºæ ¹ç›®å½•æ‰§è¡ŒæŸ¥æ‰¾å’Œé‡å‘½å

    - name: â¬†ï¸ Upload Flashable Zip
      uses: actions/upload-artifact@v4
      with:
        name: Glow-Delta-Kernel-Flashable-Zip
        path: ${{ steps.get_zip_name.outputs.NEW_ZIP_NAME }} # ä¸Šä¼ æœ€ç»ˆçš„åˆ·æœºåŒ…
        if-no-files-found: error # å¦‚æœæ‰¾ä¸åˆ°æ–‡ä»¶åˆ™æŠ¥é”™
        retention-days: 7 # è®¾ç½® Artifact çš„ä¿ç•™å¤©æ•°ï¼Œé»˜è®¤æ˜¯ 90 å¤©ï¼Œè¿™é‡Œè®¾ç½®ä¸º 7 å¤©
