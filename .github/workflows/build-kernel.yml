name: Marble Kernel Builder

on:
  workflow_dispatch:
    inputs:
      kpm_patch:
        description: "æ˜¯å¦æ·»åŠ KPMä¿®è¡¥ï¼Ÿ"
        type: boolean
        required: true
        default: true

env:
  DEVICE_CODENAME: marble
  KERNEL_NAME: Melt
  KERNEL_REPO: Guxin12/marble_kernel
  KERNEL_BRANCH: Glow-4LazyGoogle
  CLANG_COMMIT: 428d18d9732aa7ebfcaed87a582d86155db878d4
  CLANG_VERSION: r416183b

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: ğŸ§° å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses-dev bison flex libssl-dev libelf-dev \
            git curl unzip bc python3 make gcc g++ patch rsync kmod cpio \
            liblz4-tool lz4 xxd  # æ·»åŠ æ›´å¤šå†…æ ¸ç¼–è¯‘å¸¸ç”¨å·¥å…·

      - name: ğŸ“¥ æ£€å‡ºå†…æ ¸æºç 
        uses: actions/checkout@v4
        with:
          repository: ${{ env.KERNEL_REPO }}
          ref: ${{ env.KERNEL_BRANCH }}
          path: kernel
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: âš™ï¸ è®¾ç½®Clangå·¥å…·é“¾
        run: |
          mkdir -p clang
          echo "ä¸‹è½½Clangå·¥å…·é“¾..."
          curl -L -o clang/clang.tar.gz "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/${{ env.CLANG_COMMIT }}/clang-${{ env.CLANG_VERSION }}.tar.gz" || {
            echo "Clangä¸‹è½½å¤±è´¥!"
            exit 1
          }
          tar -zxf clang/clang.tar.gz -C clang
          rm clang/clang.tar.gz  # æ¸…ç†å‹ç¼©åŒ…
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "CLANG_PATH=$(pwd)/clang/bin" >> $GITHUB_ENV
          echo "PATH=$CLANG_PATH:$PATH" >> $GITHUB_ENV

      - name: âš¡ åº”ç”¨SUSFSè¡¥ä¸
        working-directory: ./kernel
        run: |
          echo "æœç´¢SUSFSè¡¥ä¸æ–‡ä»¶..."
          PATCH_FILE=$(find . -name '50_add_susfs_in_gki-*.patch' | head -n 1)
          
          if [ -z "$PATCH_FILE" ]; then
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°SUSFSè¡¥ä¸æ–‡ä»¶"
          else
            echo "åº”ç”¨SUSFSè¡¥ä¸: $PATCH_FILE"
            patch -p1 --fuzz=3 < $PATCH_FILE || {
              echo "SUSFSè¡¥ä¸åº”ç”¨å¤±è´¥!"
              exit 1
            }
            rm $PATCH_FILE  # åˆ é™¤è¡¥ä¸æ–‡ä»¶
            echo "SUSFSè¡¥ä¸åº”ç”¨æˆåŠŸ"
          fi

      - name: ğŸ”¨ ç¼–è¯‘å†…æ ¸
        id: build_kernel
        working-directory: ./kernel
        run: |
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
          export ARCH=arm64
          export KBUILD_BUILD_HOST="GitHubActions"
          export KBUILD_BUILD_USER=${{ env.KERNEL_NAME }}
          export LLVM=1
          export LLVM_IAS=1
          
          # æ¸…ç†æ„å»ºç¯å¢ƒ
          make O=out mrproper
          
          # é…ç½®å†…æ ¸
          make O=out ${{ env.DEVICE_CODENAME }}_defconfig
          
          # æ·»åŠ å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
          echo "CONFIG_LOCALVERSION=\"-${{ env.KERNEL_NAME }}\"" >> out/.config
          
          # ç¼–è¯‘å†…æ ¸
          make -j$(nproc --all) O=out 2>&1 | tee build.log
          
          # éªŒè¯ç¼–è¯‘ç»“æœ
          if [ ! -f "out/arch/arm64/boot/Image" ]; then
            echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥!"
            grep -i "error" build.log
            exit 1
          fi
          
          # è·å–å†…æ ¸ä¿¡æ¯
          BUILD_VERSION=$(make -s kernelversion O=out)
          BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "KERNEL_VERSION=$BUILD_VERSION" >> $GITHUB_ENV
          echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_ENV
          echo "IMAGE_PATH=$(pwd)/out/arch/arm64/boot/Image" >> $GITHUB_ENV
          echo "ARTIFACT_PREFIX=original" >> $GITHUB_ENV
          
          echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ! ç‰ˆæœ¬: $BUILD_VERSION"

      - name: âš¡ KPMä¿®è¡¥ (å¯é€‰)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.kpm_patch == true }}
        working-directory: ./kernel/out/arch/arm64/boot
        run: |
          echo "æ‰§è¡ŒKPMä¿®è¡¥..."
          
          # ä¸‹è½½KPMä¿®è¡¥å·¥å…·
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/main/kpm/patch_linux" -o patch || {
            echo "æ— æ³•ä¸‹è½½KPMä¿®è¡¥å·¥å…·"
            exit 1
          }
          chmod +x patch
          
          # æ‰§è¡Œä¿®è¡¥
          ./patch || {
            echo "KPMä¿®è¡¥å¤±è´¥"
            exit 1
          }
          
          # æ›¿æ¢åŸå§‹å†…æ ¸é•œåƒ
          if [ -f "oImage" ]; then
            mv oImage Image
            echo "ARTIFACT_PREFIX=kpm-patched" >> $GITHUB_ENV
            echo "âœ… KPMä¿®è¡¥æˆåŠŸå®Œæˆ"
          else
            echo "âŒ KPMä¿®è¡¥å¤±è´¥: oImageæœªç”Ÿæˆ"
            exit 1
          fi

      - name: ğŸ“¦ å‡†å¤‡AnyKernel3åˆ·æœºåŒ…
        run: |
          echo "å‡†å¤‡AnyKernel3åˆ·æœºåŒ…..."
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          
          # åˆ›å»ºè‡ªå®šä¹‰anykernel.sh
          cat > AnyKernel3/anykernel.sh <<'EOF'
          #!/bin/sh
          ## AnyKernel3 Ramdisk Mod Script
          ## osm0sis @ xda-developers
          
          properties() {
            kernel.string=${{ env.KERNEL_NAME }} by Guxin12 @é…·å®‰åˆæ˜¥åœ¨è·¯é‡
            do.devicecheck=1
            do.modules=0
            do.systemless=1
            do.cleanup=1
            do.cleanuponabort=0
            device.name1=marble
            device.name2=marblein
            supported.versions=14
          }
          
          block=boot;
          is_slot_device=1;
          ramdisk_compression=auto;
          
          . tools/ak3-core.sh;
          
          if [ -L "/dev/block/bootdevice/by-name/init_boot_a" -o -L "/dev/block/by-name/init_boot_a" ]; then
              split_boot;
              flash_boot;
          else
              dump_boot;
              write_boot;
          fi;
          EOF
          
          # è®¾ç½®æƒé™
          chmod +x AnyKernel3/anykernel.sh
          
          # å¤åˆ¶å†…æ ¸é•œåƒ
          cp ${{ env.IMAGE_PATH }} AnyKernel3/
          
          # å¯é€‰ï¼šå¤åˆ¶å…¶ä»–æ–‡ä»¶å¦‚dtbo.img
          if [ -f "kernel/out/arch/arm64/boot/dtbo.img" ]; then
            cp kernel/out/arch/arm64/boot/dtbo.img AnyKernel3/
          fi

      - name: ğŸ“¦ æ‰“åŒ…åˆ·æœºåŒ…
        run: |
          ZIP_NAME="${{ env.KERNEL_NAME }}-${{ env.DEVICE_CODENAME }}-v${{ env.KERNEL_VERSION }}-${{ env.BUILD_TIMESTAMP }}"
          ZIP_NAME="$ZIP_NAME-${{ env.ARTIFACT_PREFIX }}.zip"
          
          cd AnyKernel3
          zip -r9 ../$ZIP_NAME *
          
          echo "ZIP_PATH=$(pwd)/../$ZIP_NAME" >> $GITHUB_ENV
          echo "âœ… åˆ·æœºåŒ…ç”Ÿæˆ: $ZIP_NAME"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºæˆæœ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_NAME }}-${{ env.DEVICE_CODENAME }}-v${{ env.KERNEL_VERSION }}-${{ env.BUILD_TIMESTAMP }}
          path: |
            ${{ env.IMAGE_PATH }}
            ${{ env.ZIP_PATH }}
            kernel/build.log
          retention-days: 7
          
      - name: ğŸ’¬ å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… ${{ env.KERNEL_NAME }} å†…æ ¸ç¼–è¯‘å®Œæˆ!"
          echo "è®¾å¤‡: ${{ env.DEVICE_CODENAME }}"
          echo "ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}"
          echo "ç±»å‹: ${{ env.ARTIFACT_PREFIX }}"
          echo "æ—¶é—´: ${{ env.BUILD_TIMESTAMP }}"
          echo "é•œåƒå¤§å°: $(du -h ${{ env.IMAGE_PATH }} | awk '{print $1}')"
          echo "åˆ·æœºåŒ…å¤§å°: $(du -h ${{ env.ZIP_PATH }} | awk '{print $1}')"
