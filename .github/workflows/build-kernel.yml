name: Build Glow-Delta Kernel for Marble Device

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # å¢åŠ è¶…æ—¶æ—¶é—´

    env:
      DEVICE_CODENAME: marble
      KERNEL_NAME: Glow-Delta
      # å…³é”®ä¿®å¤ï¼šä½¿ç”¨ä¸´æ—¶ç›®å½•ä½œä¸ºccacheè·¯å¾„ï¼Œé¿å…æƒé™é—®é¢˜
      CCACHE_DIR: /tmp/ccache
      CCACHE_COMPRESS: 1  # å¯ç”¨å‹ç¼©èŠ‚çœç©ºé—´

    steps:
    - name: ğŸš€ Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        submodules: recursive
        path: kernel_source
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

    - name: ğŸ“¦ Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git flex bison build-essential libncurses-dev libssl-dev bc \
          ccache rsync zlib1g-dev python3-minimal libelf-dev libxml2-utils \
          gnupg wget unzip lz4 cpio kmod liblz4-tool
          
        # å®‰è£…æœ€æ–°ç‰ˆccacheå¹¶é…ç½®
        sudo apt-get install -y ccache
        echo "Max cache size = 2.0G" | sudo tee -a /etc/ccache.conf
        sudo chmod 777 /tmp  # ç¡®ä¿ä¸´æ—¶ç›®å½•å¯å†™
        ccache -s  # æ˜¾ç¤ºccacheåˆå§‹çŠ¶æ€

    - name: âš™ï¸ Setup Android Clang Toolchain
      uses: kdrag0n/android-toolchains-action@v1
      with:
        version: r487747b # 2024å¹´ç¨³å®šç‰ˆæœ¬
        target: aarch64-linux-android
        install-dir: /tmp/toolchain  # ä½¿ç”¨ä¸´æ—¶ç›®å½•é¿å…æƒé™é—®é¢˜

    - name: ğŸ› ï¸ Configure Build Environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-android-" >> $GITHUB_ENV
        echo "CC=clang" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
        
        # å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å·¥å…·é“¾è·¯å¾„
        echo "PATH=/tmp/toolchain/bin:$PATH" >> $GITHUB_ENV
        
        # è·å–ç²¾ç¡®çš„gitæè¿°ç”¨äºç‰ˆæœ¬
        KERNEL_VERSION=$(git -C kernel_source describe --always --dirty --tags)
        echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
        
        # é…ç½®ccacheç¯å¢ƒå˜é‡
        echo "USE_CCACHE=1" >> $GITHUB_ENV
        echo "CCACHE_BASEDIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
        mkdir -p $CCACHE_DIR
        chmod 777 $CCACHE_DIR  # ç¡®ä¿ccacheç›®å½•å¯å†™

    - name: ğŸ§¹ Clean Previous Build
      run: |
        make O=out clean && make O=out mrproper
        # æ¸…é™¤æ—§çš„ç¼“å­˜é”æ–‡ä»¶
        find $CCACHE_DIR -name '*.lock' -exec rm -f {} +
      working-directory: ./kernel_source

    - name: âš™ï¸ Configure Kernel (defconfig)
      run: |
        # å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ˜¾å¼ç»å¯¹è·¯å¾„æŒ‡å®šç¼–è¯‘å™¨
        make O=out CC="ccache clang" ${DEVICE_CODENAME}_defconfig
      working-directory: ./kernel_source
      env:
        DEVICE_CODENAME: ${{ env.DEVICE_CODENAME }}

    - name: ğŸ”¨ Build Kernel Image
      run: |
        # å…³é”®ä¼˜åŒ–ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—è¾“å‡ºç”¨äºè°ƒè¯•
        echo "Starting kernel build with $(nproc --all) jobs"
        echo "Current PATH: $PATH"
        echo "CCACHE_DIR contents:"
        ls -l $CCACHE_DIR
        ccache -s
        
        # å®é™…ç¼–è¯‘å‘½ä»¤
        time make -j$(nproc --all) O=out \
          CC="ccache clang" \
          ARCH=arm64 \
          CROSS_COMPILE=aarch64-linux-android- \
          HOSTCC="gcc"  # ä¿®å¤hostå·¥å…·é“¾é—®é¢˜
          
        ccache -s  # æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
      working-directory: ./kernel_source
      timeout-minutes: 90

    - name: ğŸ“¥ Prepare AnyKernel3
      uses: actions/checkout@v4
      with:
        repository: osm0sis/AnyKernel3
        path: AnyKernel3
        ref: master

    - name: ğŸ“¦ Package Kernel
      run: |
        # å…³é”®ä¿®å¤ï¼šç¡®ä¿è¾“å‡ºæ–‡ä»¶å­˜åœ¨
        echo "Checking kernel build artifacts:"
        ls -l out/arch/arm64/boot/
        
        # ä¸ºMarbleè®¾å¤‡ä½¿ç”¨æ­£ç¡®çš„å†…æ ¸æ ¼å¼
        KERNEL_IMAGE=out/arch/arm64/boot/Image.lz4
        DTBO_IMAGE=out/arch/arm64/boot/dtbo.img
        
        if [ ! -f $KERNEL_IMAGE ]; then
          echo "Error: Kernel image not found at $KERNEL_IMAGE!"
          exit 1
        fi
        
        cp $KERNEL_IMAGE AnyKernel3/
        [ -f $DTBO_IMAGE ] && cp $DTBO_IMAGE AnyKernel3/
        
        # æ›´æ–°AnyKernelé…ç½®
        echo "device.name1=$DEVICE_CODENAME" >> AnyKernel3/anykernel.sh
        echo "kernel.string=$KERNEL_NAME v${{ env.KERNEL_VERSION }}" >> AnyKernel3/anykernel.sh
        echo "do.devicecheck=0" >> AnyKernel3/anykernel.sh  # ç¦ç”¨è®¾å¤‡æ£€æŸ¥
        
        # åˆ›å»ºåˆ·æœºåŒ…
        cd AnyKernel3
        zip -r9 ../${KERNEL_NAME}-${DEVICE_CODENAME}-${{ env.BUILD_DATE }}.zip *
        
        # éªŒè¯æ–‡ä»¶å¤§å°
        echo "Final ZIP file:"
        ls -lh ../*.zip

    - name: â¬†ï¸ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_NAME }}-${{ env.DEVICE_CODENAME }}-${{ env.BUILD_DATE }}
        path: ${{ env.KERNEL_NAME }}-${{ env.DEVICE_CODENAME }}-*.zip
        retention-days: 7
